---
title: "R practice for stat test"
author: "ZHAI XINGYU"
date: "2024-06-17"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    number_section: true
    latex_engine: xelatex
editor_options:
  markdown:
    wrap: 72
header-includes:
  - \usepackage{amsmath}
---



# ノンパラメトリック検定

## 符号検定

中央値がある値m_0に等しいかどうかを検定すること.

$H_0: m = m_0$
$H_1: m > m_0 \space (片側検定) \space or \space m \neq m_0 \space(両側検定)$

母集団から抽出した標本：$X_1, \dots, X_n$

検定統計量T：$T=\sum{I(X_i > m_0)}, \space T \sim Bin(n, \frac{1}{2})$


``` r
> # n=7
> # the pmf plot
> dbinom(0:7,7,0.5)
FALSE [1] 0.0078125 0.0546875 0.1640625 0.2734375 0.2734375 0.1640625 0.0546875
FALSE [8] 0.0078125
```

``` r
> plot(0:7, dbinom(0:7,7,0.5),ylab = "prob", xlab="T")
```

![](Rpract_files/figure-html/unnamed-chunk-1-1.png)<!-- -->

``` r
> # alpha=0.05, one side
> qbinom(0.05,7,0.5,lower.tail = F)
FALSE [1] 6
```

## 符号付き順位検定

検定統計量T：$T=\sum{i *I(X_i > 0)}, I \sim Ber(1/2)$
$E(iI)=i*1/2, V(iI)=i^2*1/4, E(T)=1/2\sum{i}=\frac{(1+n)n}{4}, v(T)=1/4 \sum{i^2}=\frac{n(n+1)(2n+1)}{6*4}$


``` r
> # n=7(sequence)
```



# 確率過程

参考：[数学的モデリングまとめ](https://manabitimes.jp/math/1057#4);[アクチュアリー会発行の教科書](https://www.actuaries.jp/examin/textbook/)


**確率過程(stochastic process)**は時間など，
条件によって変化する確率変数の数理モデルである。

-  株価や為替の変動、ブラウン運動などの粒子のランダムな運動を数学的に記述する模型（モデル）として利用している。

-  不規則過程(random process)


**マルコフ過程(Markov process)**は現在の状態から確率的に次の状態が決まること、
**マルコフ連鎖(Markov chains)**はマルコフ過程のなかで*取りうる状態が有限*のもののことを言う。

-  ロシアの数学者:アンドレイ・アンドレエヴィチ・マルコフ(Andrey (Andrei) Andreyevich Markov)

-  未来の状態（の確率）が過去の状態によらず*現在の状態のみで決まる*ような確率過程

-  マルコフ連鎖:状態空間が離散的なマルコフ過程


**拡散過程(diffusion process)**とは*マルコフ過程*の特別な場合を指す確率過程で、
**ブラウン運動(ウィーナー過程)**とはその拡散過程の非常に特殊な場合を指します。

- *確率微分方程式(Stochastic differential equation)*の解として得られる確率過程$X_t$は拡散過程


そして拡散過程は、二つのパラメータ、*拡散係数(diffusion coefficient)*$\sigma(x,t)$と*ドリフト係数(drift coefficient)*$\mu(x,t)$によって特徴付けられます。

-  *拡散係数が1*、*ドリフト係数が0*のときをブラウン運動というのでした。





## マルコフ連鎖


<block>
マルコフ連鎖の定義:

マルコフ連鎖とは，

$$P(X_{t+1} | X_{t} , X_{t-1} , \dots,  X_1) = P(X_{t+1} | X_{t})$$
を満たすような確率変数の列$X_1, X_2, \dots$のこと。

-  $X_{t}$ によって$X_{t+1}$の傾向が決まる

-  $X_{t-1}$以前は$X_{t}$に影響しない
</block>


### 基本的な用語


-  初期分布/状態確率ベクトル

-  推移確率/遷移確率: $P(X_{t+1} | X_{t})$

注：この記事では時間的に均一（遷移確率が時刻によらない）なマルコフ連鎖を考えています。

-  推移/遷移確率行列: どの時点でも，次のステップで状態iから状態jに移る確率$q_{ij}$は一定(斉時的),
このような$q_{ij}$を(i，j)成分にもつような行列が推移確率行列Qです。

    + ij成分: iからjに推移する確率
    
    + 推移確率行列の各要素は0以上1以下です。
    
    + 推移確率行列のどの行も，行和は1です。

$$Q
=
\begin{bmatrix}
q_{11} & q_{12} & \dots  & q_{1j} & \dots  & q_{1N}\\
q_{21} & q_{22} & \dots  & q_{2j} & \dots  & q_{2N}\\
\vdots & \vdots & \ddots & \vdots & \ddots & \vdots\\
q_{i1} & q_{i2} & \dots  & q_{ij} & \dots  & q_{iN}\\
\vdots & \vdots & \ddots & \vdots & \ddots & \vdots\\
q_{N1} & q_{N2} & \dots  & q_{Nj} & \dots  & q_{NN}\\
\end{bmatrix}$$





-  状態空間:$X_t$がとりうる値の集合のこと。状態の全体, $S=\{1,2,3, \dots, N\}$

-  推移図/状態遷移図:１つ前の状態が決まると，次の状態へ移る確率が決まる




<block>


``` r
# create a dataframe
df1 <- data.frame(
  時点 = c(0,1,2,3,4,'...', 'n', 'n+1'),
  観測状態 = c(1,2,1,1,2,'...', 'i', 'j'),
  確率変数列 = c('X0=1', 'X1=2', 'X2=1', 'X3=1', 'X4=2', '...', 'Xn=i', 'Xn+1=j')
)

kable(df1, caption = 'マルコフ連鎖')
```



Table: マルコフ連鎖

|時点 |観測状態 |確率変数列 |
|:----|:--------|:----------|
|0    |1        |X0=1       |
|1    |2        |X1=2       |
|2    |1        |X2=1       |
|3    |1        |X3=1       |
|4    |2        |X4=2       |
|...  |...      |...        |
|n    |i        |Xn=i       |
|n+1  |j        |Xn+1=j     |

**NOTE:１つ前の状態が決まると，次の状態へ移る確率が決まる**

$$
P(X_4 = 2 | X_3 =2, X_2 = 1, X_1 = 2, X_0 = 1) = P(X_4 = 2 | X_3 =2) 
\rightarrow
１つ前の時点に関する条件だけで表せる
$$

**次の条件を満たすような確率変数列を離散時間のマルコフ連鎖と言います。**

${X_0, X_1, \dots, X_i}$

$$
P(X_{n+1} = j | X_{n} =i, X_{n-1} = i_{n-1}, X_{n-2} = i_{n-2}, \dots,  X_0 = i_0) = P(X_{n+1} = j | X_{n} =i)
$$

**斉時的: 条件付き確率が時点に依存しない**

$$
P(X_{n+1} = j | X_{n} =i) = q_{ij}
$$


**全確率の公式:時点nで1からNのどの状態にあったのか**

$$
P(X_{n+1} = j)= \sum_{1}^{N} {P(X_{n+1}=j|X_{n}=i)P(X_n=i)}
$$


略記

$$
P(X_n=i)=p_n(i)
$$
全確率の公式を次のように書き直すことができます。

$$
P(X_{n+1} = j)= \sum_{1}^{N} p_n(i)q_{ij}
$$


jは1からNまでの自然数のいずれかなので，そのすべてを列挙すると，次のように表せます。

$$
(p_{n+1}(1), p_{n+1}(2), \dots, p_{n+1}(j), \dots,  p_{n+1}(N))
=
(p_{n}(1), p_{n}(2), \dots, p_{n}(i), \dots,  p_{n}(N))
\begin{bmatrix}
q_{11} & q_{12} & \dots  & q_{1j} & \dots  & q_{1N}\\
q_{21} & q_{22} & \dots  & q_{2j} & \dots  & q_{2N}\\
\vdots & \vdots & \ddots & \vdots & \ddots & \vdots\\
q_{i1} & q_{i2} & \dots  & q_{ij} & \dots  & q_{iN}\\
\vdots & \vdots & \ddots & \vdots & \ddots & \vdots\\
q_{N1} & q_{N2} & \dots  & q_{Nj} & \dots  & q_{NN}\\
\end{bmatrix}
$$
</block>



### チャップマン–コルモゴロフ方程式

定理: マルコフ連鎖の推移確率行列について**「推移確率行列のn乗」** $Q^n$と**「n回の遷移の確率」**$Q^{(n)}$が
対応するという性質が成り立ちます。

-  n時刻経過に対する推移確率行列を$Q^{(n)}$と書くことにします。

-  つまり，$P(X_{t+n}=j|X_{t}=i)$をij成分に持つ行列を$Q^{(n)}$とします。

-  $Q^{(n)}=Q^n$


$$状態確率ベクトル:p_{t+n}=(初期分布:p_t)[推移確率行列:Q]^n$$

-  推移確率行列が対角化可能な行列であれば，固有値でQのn乗を手計算でも求めることができる



**チャップマン–コルモゴロフ方程式(Chapman-Kolmogorov equation)**

上記の定理より，$Q^{(n+m)}=Q^{(n)}Q^{(m)}$が成立します。

-  n時刻ぶんの遷移の様子$Q^{(n)}$とm時刻ぶんの遷移の様子$Q^{(m)}$が分かれば、
(n+m)時刻ぶんの遷移の様子$Q^{(n+m)}$も分かります。



### 定常分布

nが十分に大きければ，
n日後の状態確率ベクトルと(n＋１)日後の状態確率ベクトルはほぼ等しくなるので，
最終的な*状態確率ベクトル*をπとして，次の式が成り立つことになりそうです。

$\pi = \pi A$

このようなπを*定常分布*と言います。

*推移確率行列A*をかけても変化しないような*状態確率ベクトル$\pi$*です。


<block>
推移確率行列A

$$
A=
\begin{bmatrix}
a_1 & a_2 \\
b_1 & b_2
\end{bmatrix}
$$
定常分布$\pi = (a,b)$を求めます

$$
(a,b)
=
(a,b)
\begin{bmatrix}
a_{1} & a_{2} \\
b_{1} & b_{2}
\end{bmatrix}
$$
</block>


### 定常分布の存在と一意性

既約: すべての状態の間で有限回の移動で移り合うことができるマルコフ連鎖

一般に，既約な有限マルコフ連鎖は*ただ１つの定常分布をもつ*ことが知られています。



## ブラウン運動（ウィーナー過程）


### マルコフ連鎖n

1/n秒に１回コインを投げ、表は$+\frac{1}{\sqrt{n}}$点、裏は$-\frac{1}{\sqrt{n}}$点

<block>
**例題： マルコフ連鎖nにおいて、t秒間に得られる得点の期待値および分散**

ただし、$t=t' + t''(t' \times n は整数かつ 0 \leq t''< \frac{1}{n})$とします。

解答：　１回コインを投げて得られる得点を X で表し、t 秒間に得られる得点を S で表すと、

$$E(X)=\frac{1}{\sqrt{n}} \times \frac{1}{2} - \frac{1}{\sqrt{n}} \times \frac{1}{2}=0$$

$$E(X^2)=(\frac{1}{\sqrt{n}})^2 \times \frac{1}{2} + (\frac{1}{\sqrt{n}})^2  \times \frac{1}{2}=\frac{1}{n}$$

$$V(X)=E(X^2)-(E(X))^2=\frac{1}{2}=\frac{1}{n}$$

1/n秒に１回コインを投げ、t 秒間にコイントスは$t' \times n$回行われるので、

$$S=X_1 + \dots + X_{nt'}$$

$$E(S)=0, V(S)=t' n \times V(X) = t' $$
ここで *nを無限大*まで大きくすることを考えます。
すると、それはある確率過程となります。
その確率過程は**ブラウン運動**とよばれる確率過程です。
</block>


### ブラウン運動（Brownian motion）


以下を満たす確率過程X($\{X_t\}:X=(X_t)_{t>0} \space t時刻の位置、上記のS$)と言います。

1.  連続性：$X_t$の見本関数/パスはtに関する連続関数

2.  独立増分性：$0 \leq s < t \leq u < v \rightarrow X_t - X_s と X_v - X_uは独立$

    + または、次のような任意の時間の分割$0 = t_0 < t_1 < \dots < t_{n-1} < t_n$に対して，
    次のようなn個の増分はすべて互いに独立：$X_{t_i} - X_{t_{i-1}}$
    
    + 注：増分独立、$X_{t}$ と $X_{s}$ は独立ではないことに注意しましょう。

3.  定常増分性： $X_{s+t}-X_tとX_s同じ分布に従う$

    + 増分は期待値，分散が時間の幅(s+t-t=s)に比例する正規分布に従う


\[
\textbf{Theorem:}
任意の t > s \geq 0に対して，
X_t をブラウン運動とするとき、増分 X_t-X_s は、期待値E(X_t-X_s)・分散V(X_t-X_s)の正規分布に従う。\\
X_t-X_s \sim N[E(X_t-X_s), V(X_t-X_s)] = N[\mu (t-s), {\sigma}^2 (t-s)]
\]



一般的なブラウン運動は，*$\mu$と$\sigma$というパラメータ*を使って，次のように表せます。

$$\sigma X_t + \mu t \sim N(\mu t, {\sigma}^2 t)$$

-  $\mu$: ドリフト係数と呼ばれるもので，トレンドを表しています。

    + $\mu > 0$ならば，期待値と分散は時間が経過するほど増加することがわかります。

-  $\sigma$: 拡散係数と呼ばれるもので，$\mu t$のまわりのばらつき方を決めるパラメータです。



ただし，$X_t$と$X_s$は独立ではないことに注意しましょう。

$$cov(X_t, X_s)=cov(X_t - X_s + X_s, X_s)
=cov(X_t - X_s, X_s) + cov(X_s, X_s)
=0 + V(X_s)={\sigma}^2 s \space (増分独立により)$$


ブラウン運動は正規分布に対応する確率過程であり、正規分布がガウス分布とも呼ばれることから、
**ガウス過程（Gaussian process）**とも呼ばれます。


### 標準ブラウン運動

ブラウン運動がさらに次の条件を満たすときに、
**標準ブラウン運動（standard Brownian motion）**または**ウィーナー過程（Wiener process）**といいます。

4.  $X_0=0$

5.  $E(X_t)=0$

6.  $V(X_t)=t$

なお、ウィーナー過程($X_t \sim N(0,t)$)は、標準正規分布に対応する確率過程です。


-  $\mu=0, \sigma=1$が成り立つ場合を標準ブラウン運動と言います。




### パラメータの推定


株価など，ブラウン運動を使ってモデル化したい現象があったときに，
$\mu$や$\sigma$といったパラメータを推定する必要があります。
そのための方法として，*等しい時間間隔(独立増分性と定常増分性を利用)*で
高頻度にデータを観測する方法があります。


一般的に，一定の時間間隔をデルタ$\Delta=t/n, k=\{1, \dots,n\}$とした場合には，
となり合う時点間の増分は次の正規分布に従います。

$$
S_k = X_{k \Delta} - X_{(k-1) \Delta} \sim N(\mu \Delta, {\sigma}^2 \Delta)
$$

上の正規分布のパラメータを最尤法(MLE)で推定するとすれば，
母平均の最尤推定量は標本平均だったので，次の式になります。

$$
\hat{\mu \Delta} = \bar{S_k}=\frac{1}{n} \sum_{k=1}^{n}{S_k}\\
\hat{{\sigma}^2 \Delta} = \frac{1}{n} \sum_{k=1}^{n} (S_k - \bar{S_k})^2 = 
\frac{1}{n} \sum_{k=1}^{n}{S_k^2} - (\frac{1}{n} \sum_{k=1}^{n}{S_k})^2
$$

### 株価モデル 

ウィーナー過程は、大変扱いやすい（計算しやすい）という性質をもっており、
金融工学等の分野でよく用いられます。


-  例えば、*ブラック・ショールズ式（The Black-Scholes formula）*と呼ばれるオプションのプライシング公式も、
このブラウン運動を元に計算を行っています


## ポアソン過程
